# External Secrets Operator Helm Values
# Context: ft-transcendence DevOps Module
# Chart: external-secrets/external-secrets
#
# This configuration adapts the External Secrets Operator for our K3s environment,
# ensuring security best practices and resource efficiency.

# ------------------------------------------------------------------------------
# 1. Installation Configuration
# ------------------------------------------------------------------------------

# Install Custom Resource Definitions (CRDs) automatically with the chart.
# This is CRITICAL: The operator cannot function without its CRDs (SecretStore, ExternalSecret, etc.).
installCRDs: true

# ------------------------------------------------------------------------------
# 2. Replica Count & High Availability
# ------------------------------------------------------------------------------

# For our K3s environment (potentially single-node or small cluster), 1 replica is sufficient.
# In a large production cluster, we would increase this for High Availability.
replicaCount: 1

# ------------------------------------------------------------------------------
# 3. Security Context
# ------------------------------------------------------------------------------
# Applying "Restricted" Pod Security Standards.

# Pod-level security settings
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 65534
  seccompProfile:
    type: RuntimeDefault

# Container-level security settings
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsUser: 65534
  runAsGroup: 65534
  capabilities:
    drop:
      - ALL

# ------------------------------------------------------------------------------
# 4. Resource Management
# ------------------------------------------------------------------------------
# Minimal resource requests to fit in smaller environments, with limits to prevent leaks.

resources:
  requests:
    cpu: 10m
    memory: 32Mi
  limits:
    cpu: 100m
    memory: 128Mi

# ------------------------------------------------------------------------------
# 5. Webhook Configuration
# ------------------------------------------------------------------------------
# The webhook handles validation and conversion of ESO resources.

webhook:
  # Enable the webhook component
  create: true

  # Automatically create a self-signed certificate for the webhook admission controller.
  # We do NOT depend on cert-manager here to keep dependencies simple for ESO itself.
  createSecret: true
  certManager:
    enabled: false

  replicaCount: 1

  # Security settings for the webhook pod
  podSecurityContext:
    runAsNonRoot: true
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsUser: 65534
    runAsGroup: 65534
    capabilities:
      drop:
        - ALL

  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi

# ------------------------------------------------------------------------------
# 6. Cert Controller Configuration
# ------------------------------------------------------------------------------
# Manages the certificates for the webhook if cert-manager is not used.

certController:
  create: true
  replicaCount: 1

  podSecurityContext:
    runAsNonRoot: true
    fsGroup: 65534
    seccompProfile:
      type: RuntimeDefault

  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsUser: 65534
    runAsGroup: 65534
    capabilities:
      drop:
        - ALL

  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi

# ------------------------------------------------------------------------------
# 7. Metrics & Monitoring
# ------------------------------------------------------------------------------

serviceMonitor:
  # Disable ServiceMonitor by default to avoid dependency on Prometheus Operator during initial bootstrap.
  # Can be enabled later if Prometheus is present.
  enabled: false
